<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CHANGE: Title reflects v0.2.5 -->
    <title>ART Framework - Detailed Execution Flow v0.2.5 (Architect View)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Styles remain largely the same as v0.2.4 --- */
        :root {
            --primary: #4F46E5; --primary-light: #EEF2FF; --primary-dark: #3730A3;
            --secondary: #6366F1;
            --success: #10B981; --success-light: #ECFDF5; --success-dark: #047857;
            --warning: #F59E0B; --warning-light: #FFFBEB; --warning-dark: #B45309;
            --danger: #EF4444; --danger-light: #FEF2F2; --danger-dark: #B91C1C;
            --info: #3B82F6; --info-light: #EFF6FF; --info-dark: #1E40AF;
            --purple: #8B5CF6; --purple-light: #F5F3FF; --purple-dark: #6D28D9;
            --teal: #14B8A6; --teal-light: #F0FDFA; --teal-dark: #0F766E;
            --orange: #F97316; --orange-light: #FFF7ED; --orange-dark: #C2410C;
            --pink: #EC4899; --pink-light: #FDF2F8; --pink-dark: #BE185D;
            --gray-50: #F9FAFB; --gray-100: #F3F4F6; --gray-200: #E5E7EB; --gray-300: #D1D5DB;
            --gray-400: #9CA3AF; --gray-500: #6B7280; --gray-600: #4B5563; --gray-700: #374151; --gray-800: #1F2937; --gray-900: #111827;

            --text-primary: var(--gray-900); --text-secondary: var(--gray-700); --text-tertiary: var(--gray-500);
            --bg-white: #FFFFFF; --bg-light: var(--gray-50); --bg-lighter: var(--gray-100);

            --border-light: var(--gray-200); --border-medium: var(--gray-300);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            --radius-sm: 0.25rem; --radius-md: 0.375rem; --radius-lg: 0.5rem; --radius-xl: 0.75rem; --radius-2xl: 1rem;
            --spacing-1: 0.25rem; --spacing-2: 0.5rem; --spacing-3: 0.75rem; --spacing-4: 1rem;
            --spacing-5: 1.25rem; --spacing-6: 1.5rem; --spacing-8: 2rem; --spacing-10: 2.5rem; --spacing-12: 3rem;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-lighter); color: var(--text-primary); line-height: 1.65; padding: var(--spacing-8); font-size: 15px; }
        h1, h2, h3 { color: var(--text-primary); line-height: 1.3; font-weight: 600; }
        h1 { font-size: 2rem; text-align: center; margin-bottom: var(--spacing-6); color: var(--primary-dark); }
        h2 { font-size: 1.5rem; margin-top: var(--spacing-10); margin-bottom: var(--spacing-6); color: var(--primary); border-bottom: 2px solid var(--border-light); padding-bottom: var(--spacing-2); }
        code { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.9em; background-color: rgba(0,0,0,0.04); padding: 0.15em 0.4em; border-radius: var(--radius-sm); border: 1px solid var(--border-light); }
        .container { max-width: 1280px; margin: 0 auto; background-color: var(--bg-white); border-radius: var(--radius-xl); box-shadow: var(--shadow-lg); padding: var(--spacing-8); position: relative; }
        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-8); flex-wrap: wrap; gap: var(--spacing-4); }
        .intro { text-align: center; max-width: 900px; margin: 0 auto var(--spacing-10); }
        .intro p { color: var(--text-secondary); font-size: 1.1rem; }
        .pattern-selector { display: flex; justify-content: center; margin-bottom: var(--spacing-8); flex-wrap: wrap; gap: var(--spacing-4); }
        .flow-header { text-align: center; margin-bottom: var(--spacing-8); padding-bottom: var(--spacing-4); border-bottom: 1px solid var(--border-light); }
        .flow-header h2 { margin-top: 0; color: var(--primary); }
        .flow-header p { color: var(--text-secondary); }
        .execution-flow { position: relative; padding: var(--spacing-8) 0; }
        .flow-stage { margin-bottom: var(--spacing-12); position: relative; padding-top: var(--spacing-2); }
        .stage-header { display: flex; align-items: center; margin-bottom: var(--spacing-6); }
        .stage-number { width: 44px; height: 44px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: var(--spacing-4); flex-shrink: 0; box-shadow: var(--shadow-sm); }
        .stage-title { font-size: 1.3rem; font-weight: 600; color: var(--primary); }
        .stage-description { color: var(--text-secondary); margin-left: calc(44px + var(--spacing-4)); margin-bottom: var(--spacing-6); padding-left: var(--spacing-4); border-left: 3px solid var(--border-light); font-size: 0.98rem; }
        .component-flow { margin-left: calc(44px + var(--spacing-4)); position: relative; }
        .component-flow::before { content: ''; position: absolute; top: var(--spacing-4); bottom: var(--spacing-4); left: 14px; width: 3px; background-color: var(--border-medium); z-index: 1; border-radius: 2px; }
        .component-interaction { display: flex; margin-bottom: var(--spacing-6); position: relative; align-items: flex-start; }
        .component-interaction:last-child { margin-bottom: 0; }
        .interaction-line { position: absolute; top: calc(15px + var(--spacing-2)); left: 15px; width: calc(var(--spacing-4) - 1px); height: 3px; background-color: var(--border-medium); z-index: 1; border-radius: 1px; }
        .interaction-dot { width: 30px; height: 30px; border-radius: 50%; background-color: var(--bg-white); border: 3px solid var(--gray-400); margin-right: var(--spacing-4); flex-shrink: 0; position: relative; z-index: 2; margin-top: var(--spacing-2); box-shadow: var(--shadow-sm); }
        .interaction-details { flex-grow: 1; padding: var(--spacing-5); background-color: var(--bg-light); border-radius: var(--radius-lg); border: 1px solid var(--border-light); transition: transform 0.2s ease, box-shadow 0.2s ease; border-left-width: 4px; }
        .interaction-details:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--border-medium); }
        .interaction-details.type-init { border-left-color: var(--gray-400); background-color: var(--gray-50); }
        .interaction-details.type-storage { border-left-color: var(--orange); background-color: var(--orange-light); }
        .interaction-details.type-context { border-left-color: var(--yellow); background-color: var(--yellow-light); }
        .interaction-details.type-reasoning { border-left-color: var(--green); background-color: var(--green-light); }
        .interaction-details.type-tool { border-left-color: var(--purple); background-color: var(--purple-light); }
        .interaction-details.type-observation { border-left-color: var(--teal); background-color: var(--teal-light); }
        .interaction-details.type-ui { border-left-color: var(--pink); background-color: var(--pink-light); }
        .interaction-details.type-core { border-left-color: var(--blue); background-color: var(--blue-light); }
        .component-label { font-weight: 600; margin-bottom: var(--spacing-3); display: flex; align-items: center; font-size: 1.05rem; }
        .component-badge { font-size: 0.7rem; font-weight: 600; padding: 0.2rem 0.4rem; border-radius: var(--radius-sm); margin-right: 0.6rem; text-transform: uppercase; letter-spacing: 0.03em; display: inline-block; line-height: 1; border: 1px solid; }
        .badge-agent-core { background-color: var(--blue-light); color: var(--blue-dark); border-color: var(--blue); }
        .badge-reasoning { background-color: var(--green-light); color: var(--green-dark); border-color: var(--green); }
        .badge-tool { background-color: var(--purple-light); color: var(--purple-dark); border-color: var(--purple); }
        .badge-observation { background-color: var(--teal-light); color: var(--teal-dark); border-color: var(--teal); }
        .badge-context { background-color: var(--yellow-light); color: var(--yellow-dark); border-color: var(--yellow); }
        .badge-storage { background-color: var(--orange-light); color: var(--orange-dark); border-color: var(--orange); }
        .badge-ui { background-color: var(--pink-light); color: var(--pink-dark); border-color: var(--pink); }
        .interaction-description { font-size: 0.98rem; color: var(--text-secondary); margin-bottom: var(--spacing-4); }
        .interaction-data { margin-top: var(--spacing-4); padding-top: var(--spacing-4); border-top: 1px dashed var(--border-medium); font-size: 0.9rem; color: var(--text-tertiary); }
        .data-flow { display: flex; align-items: flex-start; margin-bottom: var(--spacing-3); }
        .data-direction { font-weight: 600; margin-right: var(--spacing-3); color: var(--text-secondary); flex-shrink: 0; min-width: 70px; text-align: right; }
        .data-content { padding: var(--spacing-2) var(--spacing-3); background-color: var(--bg-white); border-radius: var(--radius-md); border: 1px solid var(--border-medium); font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.85rem; word-break: break-word; line-height: 1.5; white-space: pre-wrap; color: var(--gray-800); flex-grow: 1; }
        .data-comment { color: var(--gray-600); font-style: italic; margin-top: var(--spacing-1); padding-left: calc(70px + var(--spacing-3)); font-size: 0.85rem; }
        .button { display: inline-block; padding: var(--spacing-2) var(--spacing-4); background-color: var(--primary); color: white; border: none; border-radius: var(--radius-md); font-weight: 500; font-size: 0.9rem; text-decoration: none; cursor: pointer; transition: background-color 0.2s ease; box-shadow: var(--shadow-sm); text-align: center; }
        .button:hover { background-color: var(--primary-dark); box-shadow: var(--shadow-md); }
        .pattern-note { margin: var(--spacing-10) 0; padding: var(--spacing-6); background-color: var(--blue-light); border-radius: var(--radius-lg); border-left: 5px solid var(--blue); box-shadow: var(--shadow-sm); }
        .pattern-note h3 { color: var(--blue-dark); margin-bottom: 0.5rem; font-size: 1.15rem; }
        .pattern-note p { color: var(--text-secondary); font-size: 1rem; }
        .pattern-alternatives { margin-top: var(--spacing-8); display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-6); }
        .pattern-card { padding: var(--spacing-6); border-radius: var(--radius-lg); background-color: var(--bg-light); border: 1px solid var(--border-light); transition: transform 0.2s ease, box-shadow 0.2s ease; display: flex; flex-direction: column; box-shadow: var(--shadow-sm); }
        .pattern-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--border-medium); }
        .pattern-card h4 { margin-bottom: 0.75rem; color: var(--primary); font-size: 1.1rem; }
        .pattern-card p { font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 0.75rem; flex-grow: 1; }
        .pattern-difference { font-size: 0.9rem; color: var(--text-tertiary); padding-top: 0.75rem; border-top: 1px dashed var(--border-medium); margin-top: auto; }
        .pattern-difference-item { display: flex; align-items: flex-start; margin-bottom: 0.5rem; }
        .difference-icon { margin-right: 0.5rem; color: var(--primary); flex-shrink: 0; margin-top: 0.2rem; font-weight: bold; }
        .system-legend { display: flex; flex-wrap: wrap; gap: var(--spacing-4); margin: var(--spacing-8) 0; padding: var(--spacing-6); background-color: var(--bg-light); border-radius: var(--radius-lg); border: 1px solid var(--border-light); }
        .legend-item { display: flex; align-items: center; margin-right: 1rem; }
        .legend-color { width: 1rem; height: 1rem; border-radius: var(--radius-sm); margin-right: 0.5rem; border: 1px solid rgba(0,0,0,0.1); }
        .legend-label { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); }
        .color-agent-core { background-color: var(--blue-light); border-color: var(--blue); }
        .color-reasoning { background-color: var(--green-light); border-color: var(--green); }
        .color-tool { background-color: var(--purple-light); border-color: var(--purple); }
        .color-observation { background-color: var(--teal-light); border-color: var(--teal); }
        .color-context { background-color: var(--yellow-light); border-color: var(--yellow); }
        .color-storage { background-color: var(--orange-light); border-color: var(--orange); }
        .color-ui { background-color: var(--pink-light); border-color: var(--pink); }
        .tool-loop-indent { margin-left: var(--spacing-8); border-left: 3px dashed var(--purple); padding-left: var(--spacing-6); margin-top: var(--spacing-6); margin-bottom: var(--spacing-6); }
        .tool-loop-header .interaction-dot { border-color: var(--purple); background-color: var(--purple-light); }
        .tool-loop-item .interaction-dot { border-color: var(--purple); }
        .stage-nav { margin-bottom: var(--spacing-8); padding: var(--spacing-4) 0; border-bottom: 1px solid var(--border-light); }
        .stage-nav ol { list-style: none; padding: 0; display: flex; flex-wrap: wrap; gap: var(--spacing-4); justify-content: center; }
        .stage-nav a { text-decoration: none; color: var(--primary); font-weight: 500; padding: var(--spacing-1) var(--spacing-3); border-radius: var(--radius-md); transition: background-color 0.2s ease, color 0.2s ease; border: 1px solid transparent; }
        .stage-nav a:hover { background-color: var(--primary-light); border-color: var(--primary); }
        .back-to-top { display: block; text-align: center; margin-top: var(--spacing-10); }
        .back-to-top a { color: var(--text-secondary); text-decoration: none; font-weight: 500; }
        .back-to-top a:hover { color: var(--primary); text-decoration: underline; }
        .new-badge { display: inline-block; background-color: var(--purple-light); color: var(--purple); padding: 0.2rem 0.4rem; border-radius: var(--radius-sm); font-size: 0.7rem; font-weight: 600; margin-left: var(--spacing-2); border: 1px solid var(--purple); vertical-align: middle;}


        @media (max-width: 768px) {
            body { padding: var(--spacing-4); }
            .container { padding: var(--spacing-6); }
            .nav-header { flex-direction: column; align-items: center; }
            .pattern-alternatives { grid-template-columns: 1fr; }
            .system-legend { flex-direction: column; gap: var(--spacing-3); align-items: flex-start;}
            .interaction-details { padding: var(--spacing-3); }
            .component-flow { margin-left: calc(44px + var(--spacing-2)); }
            .stage-description { margin-left: calc(44px + var(--spacing-2)); }
            .interaction-line { width: calc(var(--spacing-2) - 1px); }
            .interaction-dot { margin-right: var(--spacing-2); }
            .stage-nav ol { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-header">
             <!-- CHANGE: Update Title -->
             <h1>ART Framework: Detailed Execution Flow v0.2.5 (Architect View)</h1>
             <a href="./ART-framework-v0.2.5.html" class="button">Back to Framework Overview</a>
        </div>

        <div class="intro">
            <!-- CHANGE: Update description -->
            <p>This diagram presents a system architect's view of the ART framework's **Plan-Execute-Synthesize (PES)** execution flow (v0.2.5). It details component interactions reflecting the new multi-provider architecture, including dynamic routing, model registry consultation, cost tracking, enhanced configuration management, comprehensive Ollama support, and extended observability.</p>
        </div>

         <nav class="stage-nav" aria-label="Flow Stages">
             <ol>
                 <li><a href="#stage-1">1. Initiation & Config</a></li>
                 <li><a href="#stage-2">2. Planning Context</a></li>
                 <li><a href="#stage-3">3. Planning Call & Routing</a></li>
                 <li><a href="#stage-4">4. Tool Execution</a></li>
                 <li><a href="#stage-5">5. Synthesis Call & Routing</a></li>
                 <li><a href="#stage-6">6. Finalization</a></li>
             </ol>
         </nav>

        <!-- Pattern selector removed for clarity, assuming PES -->

        <div class="system-legend">
            <div class="legend-item"><div class="legend-color color-agent-core"></div><div class="legend-label">Agent Core (AC)</div></div>
            <div class="legend-item"><div class="legend-color color-reasoning"></div><div class="legend-label">Reasoning System (RS)</div></div>
            <div class="legend-item"><div class="legend-color color-tool"></div><div class="legend-label">Tool System (TS)</div></div>
            <div class="legend-item"><div class="legend-color color-observation"></div><div class="legend-label">Observation System (OS)</div></div>
            <div class="legend-item"><div class="legend-color color-context"></div><div class="legend-label">Context System (CS)</div></div>
            <div class="legend-item"><div class="legend-color color-storage"></div><div class="legend-label">Storage System (SS)</div></div>
            <div class="legend-item"><div class="legend-color color-ui"></div><div class="legend-label">UI System (UI)</div></div>
        </div>

        <div class="flow-header">
            <h2>Plan-Execute-Synthesize (PES) Pattern Execution Flow (v0.2.5)</h2>
            <p>A robust, observable flow leveraging the multi-provider reasoning system.</p>
        </div>

        <div class="execution-flow">
            <!-- Stage 1: Initiation & Configuration Loading -->
            <div class="flow-stage" id="stage-1">
                <div class="stage-header"><div class="stage-number">1</div><div class="stage-title">Request Initiation & Configuration Loading</div></div>
                 <!-- CHANGE: Update description -->
                <div class="stage-description">
                    An execution request arrives. The `AgentFactory` initializes core components, including the `ProviderInstanceManager` which instantiates all configured provider adapters (e.g., OpenAI, Ollama). The `StateManager` retrieves the specific thread's configuration (`ThreadConfig`) which now includes the target `instanceId` and preferences.
                </div>
                <div class="component-flow">
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-core">
                            <div class="component-label"><span class="component-badge badge-agent-core">AC</span> Agent Core Receives Request</div>
                            <div class="interaction-description">Application invokes `artInstance.process()` with `AgentProps`.</div>
                            <div class="interaction-data">
                                <div class="data-flow"><span class="data-direction">Input:</span><code class="data-content">AgentProps { query, threadId, ... }</code></div>
                            </div>
                        </div>
                    </div>
                    <!-- CHANGE: Added ProviderInstanceManager Initialization -->
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-reasoning">
                             <div class="component-label"><span class="component-badge badge-reasoning">RS</span> ProviderInstanceManager Initializes Adapters <span class="new-badge">New</span></div>
                            <div class="interaction-description">(During `createArtInstance`) Iterates through `ProviderInstanceConfig[]`. Instantiates adapters (e.g., `OllamaAdapter`, `OpenAIAdapter`). Checks `isLocal` constraint. May interact with `EncryptedSecretsRepository` for API keys.</div>
                             <div class="interaction-data">
                                 <div class="data-flow"><span class="data-direction">Config:</span><code class="data-content">ProviderInstanceConfig[] // From AgentFactoryConfig</code></div>
                                 <div class="data-flow"><span class="data-direction">Output:</span><code class="data-content">Internal Map<string, ProviderAdapter> // Maps instanceId to adapter</code></div>
                             </div>
                        </div>
                    </div>
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-context">
                            <div class="component-label"><span class="component-badge badge-context">CS</span> State Manager Loads Thread Configuration & State</div>
                            <!-- CHANGE: Mention new ThreadConfig structure -->
                            <div class="interaction-description">Uses `threadId` to query `StateRepository` for the thread's specific `ThreadConfig` (containing `reasoning.instanceId`, `modelPreferences`, `costPreferences`) and `AgentState`.</div>
                            <div class="interaction-data">
                                <div class="data-flow"><span class="data-direction">Request:</span><code class="data-content">stateManager.loadThreadContext(threadId, userId?)</code></div>
                            </div>
                        </div>
                    </div>
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-storage">
                            <div class="component-label"><span class="component-badge badge-storage">SS</span> Storage System Provides Config & State</div>
                            <div class="interaction-description">`StateRepository` uses `StorageAdapter` to fetch `ThreadConfig` and `AgentState`.</div>
                             <div class="interaction-data">
                                <div class="data-flow"><span class="data-direction">Query 1:</span><code class="data-content">storageAdapter.get('threadConfigs', threadId)</code></div>
                                <div class="data-flow"><span class="data-direction">Query 2:</span><code class="data-content">storageAdapter.get('agentState', threadId)</code></div>
                                <!-- CHANGE: Show new ThreadConfig structure -->
                                <div class="data-flow"><span class="data-direction">Response:</span><code class="data-content">Promise<{ config: ThreadConfig, state: AgentState | null }></code></div>
                                <div class="data-comment"><code>ThreadConfig { reasoning: { instanceId, model?, prefs? }, ... }</code></div>
                            </div>
                        </div>
                    </div>
                     <!-- Removed Agent Factory Configures Instance - Initialization handled earlier -->
                </div>
            </div>

            <!-- Stage 2: Planning Context Assembly -->
            <div class="flow-stage" id="stage-2">
                <div class="stage-header"><div class="stage-number">2</div><div class="stage-title">Planning Context Assembly</div></div>
                <!-- CHANGE: Slightly updated description -->
                <div class="stage-description">
                    Information required for the planning LLM call is gathered: conversation history, schemas of *enabled* tools for this thread, and the system prompt.
                </div>
                 <div class="component-flow">
                    <!-- Interactions mostly unchanged from v0.2.4 -->
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-context">
                            <div class="component-label"><span class="component-badge badge-context">CS</span> Conversation Manager Retrieves History</div>
                            <div class="interaction-description">Fetches recent messages for `threadId` via `ConversationRepository`.</div>
                        </div>
                    </div>
                     <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-storage">
                            <div class="component-label"><span class="component-badge badge-storage">SS</span> Storage System Provides History</div>
                            <div class="interaction-description">`ConversationRepository` queries `StorageAdapter`.</div>
                        </div>
                    </div>
                     <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-context">
                            <div class="component-label"><span class="component-badge badge-context">CS</span> State Manager Provides Enabled Tool Names</div>
                            <div class="interaction-description">Provides the list of tool names enabled in the loaded `ThreadConfig`.</div>
                        </div>
                    </div>
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-tool">
                            <div class="component-label"><span class="component-badge badge-tool">TS</span> Tool Registry Provides Enabled Tool Schemas</div>
                            <div class="interaction-description">Uses enabled names to retrieve relevant `ToolSchema` definitions.</div>
                        </div>
                    </div>
                     <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-context">
                            <div class="component-label"><span class="component-badge badge-context">CS</span> State Manager Provides System Prompt</div>
                            <div class="interaction-description">Retrieves the base system prompt from the loaded config.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stage 3: Planning Call & Routing -->
             <!-- CHANGE: Title and description updated -->
            <div class="flow-stage" id="stage-3">
                <div class="stage-header"><div class="stage-number">3</div><div class="stage-title">Planning Call & Routing (1st LLM Call)</div></div>
                 <div class="stage-description">
                    The first LLM interaction generates the plan. Agent Core provides `requiredCapabilities`. `ReasoningEngine` invokes `ModelRouter` to select the best provider instance and model based on capabilities, thread preferences (`modelPreferences`, `costPreferences`), and `ModelRegistry` data. The call is dispatched to the selected adapter instance via `ProviderInstanceManager`. Thoughts, intent, plan, and tool calls are parsed and observed. Cost is tracked.
                </div>
                <div class="component-flow">
                     <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-core">
                            <div class="component-label"><span class="component-badge badge-agent-core">AC</span> Orchestrates Planning Sequence</div>
                             <!-- CHANGE: Mention passing capabilities -->
                            <div class="interaction-description">Initiates planning call via `ReasoningEngine`, passing `query` and `requiredCapabilities` (e.g., `REASONING`, `TOOL_USE`).</div>
                             <div class="interaction-data">
                                <div class="data-flow"><span class="data-direction">Call:</span><code class="data-content">reasoningEngine.call(planningPrompt, callOptions)</code></div>
                                <div class="data-comment"><code>CallOptions { threadId, requiredCapabilities, ... }</code></div>
                            </div>
                        </div>
                    </div>
                     <!-- CHANGE: Added Routing Steps -->
                     <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-reasoning">
                            <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Model Router Selects Instance & Model <span class="new-badge">New</span></div>
                            <div class="interaction-description">`ReasoningEngine` delegates to `ModelRouter`. Router uses `threadId`, `requiredCapabilities`. Consults `StateManager` for `ThreadConfig` (preferences). Consults `ModelRegistry` for models matching capabilities. Consults `CostTrackingService` (optional pre-check). Applies selection logic (prefs, cost, fallback chains).</div>
                             <div class="interaction-data">
                                <div class="data-flow"><span class="data-direction">Input:</span><code class="data-content">{ threadId, requiredCapabilities }</code></div>
                                <div class="data-flow"><span class="data-direction">Interacts:</span><code class="data-content">StateManager, ModelRegistry, CostTrackingService</code></div>
                                <div class="data-flow"><span class="data-direction">Output:</span><code class="data-content">{ instanceId: string, modelId: string }</code></div>
                            </div>
                        </div>
                    </div>
                     <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-observation">
                            <div class="component-label"><span class="component-badge badge-observation">OS</span> Record Route Decision <span class="new-badge">New</span></div>
                            <div class="interaction-description">`ObservationManager` records `MODEL_ROUTE_DECISION` with selected `instanceId`, `modelId`.</div>
                        </div>
                    </div>
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-reasoning">
                            <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Reasoning Engine Retrieves Adapter</div>
                            <div class="interaction-description">Uses selected `instanceId` to get the specific adapter instance from `ProviderInstanceManager`.</div>
                            <div class="interaction-data">
                                 <div class="data-flow"><span class="data-direction">Call:</span><code class="data-content">providerInstanceManager.getProvider(instanceId)</code></div>
                                <div class="data-flow"><span class="data-direction">Returns:</span><code class="data-content">ProviderAdapter // e.g., OllamaAdapter instance</code></div>
                            </div>
                        </div>
                    </div>
                     <!-- End Routing Steps -->
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-reasoning">
                            <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Prompt Manager Creates Planning Prompt</div>
                            <div class="interaction-description">Constructs the prompt using history, enabled tool schemas, system prompt, query. *(TODO: Needs provider context for optimal formatting)*</div>
                        </div>
                    </div>
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-reasoning">
                             <!-- CHANGE: Call specific adapter -->
                            <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Selected Adapter Executes LLM Call</div>
                            <div class="interaction-description">Invokes `adapter.call()` on the retrieved instance (e.g., `ollamaAdapter.call`). Passes merged options including `onThought`, `onChunk`, `abortSignal`, `images`, `tools`. Handles provider API interaction.</div>
                             <div class="interaction-data">
                                <div class="data-flow"><span class="data-direction">Call:</span><code class="data-content">adapter.call(prompt, finalCallOptions)</code></div>
                                <div class="data-comment"><code>finalCallOptions { threadId, modelId, params, onThought, onChunk, images?, tools?, abortSignal?, ... }</code></div>
                                <div class="data-flow"><span class="data-direction">Response:</span><code class="data-content">Promise<string> // Raw LLM Response</code></div>
                            </div>
                        </div>
                    </div>
                     <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-observation">
                             <!-- CHANGE: Mention onChunk -->
                            <div class="component-label"><span class="component-badge badge-observation">OS</span> Record Thoughts/Chunks (Callbacks)</div>
                            <div class="interaction-description">`onThought`/`onChunk` trigger `observationManager.record` for `THOUGHTS` or streamed content observations.</div>
                        </div>
                    </div>
                    <!-- CHANGE: Added Cost Tracking Step -->
                     <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-reasoning">
                            <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Cost Tracking Service Records Usage <span class="new-badge">New</span></div>
                            <div class="interaction-description">After successful call, `ReasoningEngine` reports usage (tokens, model) to `CostTrackingService`. Service calculates cost, checks budget, potentially records `COST_WARNING` observation.</div>
                             <div class="interaction-data">
                                 <div class="data-flow"><span class="data-direction">Call:</span><code class="data-content">costTracker.recordUsage(threadId, instanceId, modelId, inTokens, outTokens)</code></div>
                            </div>
                        </div>
                    </div>
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-reasoning">
                            <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Output Parser Processes Planning Response</div>
                            <div class="interaction-description">Parses raw response for intent, plan, tool calls.</div>
                        </div>
                    </div>
                     <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-observation">
                            <div class="component-label"><span class="component-badge badge-observation">OS</span> Record Parsing Outcome</div>
                            <div class="interaction-description">Creates `INTENT`, `PLAN`, `TOOL_CALL` observations on success, or `ERROR`.</div>
                        </div>
                    </div>
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-storage">
                            <div class="component-label"><span class="component-badge badge-storage">SS</span> Persist Planning Observations</div>
                            <div class="interaction-description">`ObservationRepository` saves all observations.</div>
                        </div>
                    </div>
                     <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-ui">
                            <div class="component-label"><span class="component-badge badge-ui">UI</span> Notify UI (Observations & Model Events)</div>
                            <div class="interaction-description">`ObservationSocket` emits planning observations. `ModelSocket` emits relevant events (e.g., `MODEL_SELECTED`, `COST_WARNING`).</div>
                        </div>
                    </div>
                </div>
            </div>

             <!-- Stage 4: Tool Execution Phase -->
             <!-- No major changes needed in the flow steps for v0.2.5 -->
            <div class="flow-stage" id="stage-4">
                <div class="stage-header"><div class="stage-number">4</div><div class="stage-title">Tool Execution Phase</div></div>
                 <div class="stage-description">
                    The `ToolSystem` executes the sequence of tool calls specified in the validated plan. Each call is validated against its schema, run securely, and the outcome is captured as an observation.
                </div>
                <div class="component-flow">
                    <!-- Tool Loop interactions remain the same as v0.2.4 conceptually -->
                    <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-core"> <div class="component-label"><span class="component-badge badge-agent-core">AC</span> Initiates Tool Execution</div></div></div>
                    <div class="component-interaction tool-loop-header"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-tool" style="border-left: 3px solid var(--purple);"><div class="component-label"><span class="component-badge badge-tool">TS</span> Tool System Iterates:</div></div></div>
                    <div class="tool-loop-indent">
                        <div class="component-interaction tool-loop-item"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-tool"> <div class="component-label"><span class="component-badge badge-tool">TS</span> Look Up & Validate Executor</div></div></div>
                        <div class="component-interaction tool-loop-item"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-tool"> <div class="component-label"><span class="component-badge badge-tool">TS</span> Validate Input Arguments</div></div></div>
                        <div class="component-interaction tool-loop-item"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-tool"> <div class="component-label"><span class="component-badge badge-tool">TS</span> Execute Tool Logic</div></div></div>
                        <div class="component-interaction tool-loop-item"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-observation"> <div class="component-label"><span class="component-badge badge-observation">OS</span> Record Tool Execution Observation</div></div></div>
                        <div class="component-interaction tool-loop-item"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-storage"> <div class="component-label"><span class="component-badge badge-storage">SS</span> Persist Tool Observation</div></div></div>
                        <div class="component-interaction tool-loop-item"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-ui"> <div class="component-label"><span class="component-badge badge-ui">UI</span> Notify UI of Tool Result</div></div></div>
                    </div>
                    <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-tool"> <div class="component-label"><span class="component-badge badge-tool">TS</span> Return Aggregate Tool Results</div></div></div>
                </div>
            </div>

            <!-- Stage 5: Synthesis Call & Routing -->
             <!-- CHANGE: Title and flow updated similar to Stage 3 -->
            <div class="flow-stage" id="stage-5">
                <div class="stage-header"><div class="stage-number">5</div><div class="stage-title">Synthesis Call & Routing (2nd LLM Call)</div></div>
                <div class="stage-description">
                    The final response is generated. `AgentCore` may specify `TEXT` capability. `ReasoningEngine` invokes `ModelRouter` again to select the appropriate instance/model (often simpler for synthesis). The call is dispatched, thoughts/chunks streamed, cost tracked, and the final text parsed.
                </div>
                 <div class="component-flow">
                    <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-core"> <div class="component-label"><span class="component-badge badge-agent-core">AC</span> Orchestrates Synthesis</div> <div class="interaction-description">Initiates final response generation, potentially specifying `requiredCapabilities: [ModelCapability.TEXT]`.</div></div></div>
                    <!-- Routing Steps (Similar to Stage 3, potentially simpler criteria) -->
                     <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-reasoning"> <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Model Router Selects Instance & Model <span class="new-badge">New</span></div> <div class="interaction-description">Selects instance/model for synthesis based on capabilities (e.g., TEXT), thread preferences, etc.</div></div></div>
                     <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-observation"> <div class="component-label"><span class="component-badge badge-observation">OS</span> Record Route Decision <span class="new-badge">New</span></div></div></div>
                    <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-reasoning"> <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Reasoning Engine Retrieves Adapter</div></div></div>
                    <!-- End Routing Steps -->
                    <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-reasoning"> <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Prompt Manager Creates Synthesis Prompt</div> <div class="interaction-description">Constructs prompt using query, plan, tool results, history.</div></div></div>
                    <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-reasoning"> <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Selected Adapter Executes Synthesis LLM Call</div> <div class="interaction-description">Invokes `adapter.call()` on the selected instance. Streams via `onThought`/`onChunk`. Handles `AbortSignal`.</div></div></div>
                     <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-observation"> <div class="component-label"><span class="component-badge badge-observation">OS</span> Record Synthesis Thoughts/Chunks</div></div></div>
                     <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-reasoning"> <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Cost Tracking Service Records Usage <span class="new-badge">New</span></div></div></div>
                    <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-storage"> <div class="component-label"><span class="component-badge badge-storage">SS</span> Persist Synthesis Observations</div></div></div>
                    <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-ui"> <div class="component-label"><span class="component-badge badge-ui">UI</span> Notify UI of Thoughts/Chunks</div></div></div>
                     <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-reasoning"> <div class="component-label"><span class="component-badge badge-reasoning">RS</span> Output Parser Extracts Final Response Text</div></div></div>
                     <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-observation"> <div class="component-label"><span class="component-badge badge-observation">OS</span> Record Parsing Outcome (Optional Error)</div></div></div>
                </div>
            </div>

            <!-- Stage 6: Finalization & Response Delivery -->
            <div class="flow-stage" id="stage-6">
                <div class="stage-header"><div class="stage-number">6</div><div class="stage-title">Finalization & Response Delivery</div></div>
                 <!-- CHANGE: Updated description -->
                <div class="stage-description">
                    The cycle concludes. Structured messages (User & AI) are created with metadata (incl. instance/model used, cost), persisted, and broadcast via UI sockets. State changes are saved. The final result is returned.
                </div>
                 <div class="component-flow">
                     <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-core">
                            <div class="component-label"><span class="component-badge badge-agent-core">AC</span> Format Final User & Agent Messages</div>
                             <!-- CHANGE: Updated metadata example -->
                            <div class="interaction-description">Creates `ConversationMessage` objects with rich metadata.</div>
                              <div class="interaction-data">
                                <div class="data-flow"><span class="data-direction">Creates:</span><code class="data-content">UserMessage { ..., metadata: { userId?, sessionId? } }</code></div>
                                <div class="data-flow"><span class="data-direction">Creates:</span><code class="data-content">AgentMessage { ..., metadata: { traceId?, ..., instanceIdUsed?, modelIdUsed?, toolCallIds?, relatedObsIds?, durationMs?, estimatedCost?, totalTokens? } }</code></div>
                            </div>
                        </div>
                    </div>
                    <!-- Other steps (Persist History, Persist State, Notify UI) remain conceptually similar -->
                    <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-context"> <div class="component-label"><span class="component-badge badge-context">CS</span> Persist Conversation History</div></div></div>
                    <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-storage"> <div class="component-label"><span class="component-badge badge-storage">SS</span> Storage Adapter Saves Messages</div></div></div>
                    <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-context"> <div class="component-label"><span class="component-badge badge-context">CS</span> Persist State Changes (If Any)</div></div></div>
                     <div class="component-interaction"> <div class="interaction-dot"></div><div class="interaction-line"></div> <div class="interaction-details type-storage"> <div class="component-label"><span class="component-badge badge-storage">SS</span> Storage Adapter Saves State (If Changed)</div></div></div>
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-ui">
                            <div class="component-label"><span class="component-badge badge-ui">UI</span> Notify UI of New Messages</div>
                            <!-- CHANGE: Mention ModelSocket for final status -->
                            <div class="interaction-description">`ConversationSocket` emits messages. `ModelSocket` might emit final status/cost events.</div>
                            <div class="interaction-data">
                                <div class="data-flow"><span class="data-direction">Event:</span><code class="data-content">conversationSocket.notify(UserMessage)</code></div>
                                <div class="data-flow"><span class="data-direction">Event:</span><code class="data-content">conversationSocket.notify(AgentMessage)</code></div>
                                <div class="data-flow"><span class="data-direction">Event:</span><code class="data-content">modelSocket.notify(ModelEvent<COST_UPDATE | ...>)</code></div>
                            </div>
                        </div>
                    </div>
                    <div class="component-interaction">
                        <div class="interaction-dot"></div><div class="interaction-line"></div>
                        <div class="interaction-details type-core">
                            <div class="component-label"><span class="component-badge badge-agent-core">AC</span> Return Final Result Structure</div>
                            <!-- CHANGE: Updated metadata example -->
                            <div class="interaction-description">`artInstance.process()` resolves with `AgentMessage` and updated `ExecutionMetadata`.</div>
                            <div class="interaction-data">
                                <div class="data-flow"><span class="data-direction">Returns:</span><code class="data-content">Promise<AgentFinalResponse></code></div>
                                <div class="data-comment"><code>Metadata { ..., status, durationMs, llmCalls, toolCalls, estimatedCost?, totalTokens? }</code></div>
                            </div>
                        </div>
                    </div>
                     <div class="component-interaction">
                        <div class="interaction-dot"></div>
                         <div class="interaction-line" style="height:0px;"></div> <!-- End of line -->
                        <div class="interaction-details type-ui">
                            <div class="component-label"><span class="component-badge badge-ui">UI</span> Application Renders Final Response</div>
                            <div class="interaction-description">UI displays the final `AgentMessage` content.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="pattern-note">
            <h3>Architectural Summary (v0.2.5)</h3>
            <!-- CHANGE: Updated summary -->
            <p>This v0.2.5 flow showcases the PES pattern operating within the enhanced multi-provider architecture. Key changes include dynamic routing via `ModelRouter` based on thread configuration (`instanceId`, preferences) and capabilities, leveraging the `ProviderInstanceManager` and `ModelRegistry`. Cost tracking, extended adapter features (streaming chunks, aborts), and detailed model management observability via `ModelSocket` are integrated throughout the process.</p>
        </div>

        <!-- Alternative patterns section remains conceptually the same -->
        <h2>Alternative Reasoning Patterns</h2>
        <div class="pattern-alternatives">
             <div class="pattern-card"><h4>ReAct Pattern</h4> <p>...</p> <div class="pattern-difference">...</div> </div>
             <div class="pattern-card"><h4>Chain of Thought (CoT)</h4> <p>...</p> <div class="pattern-difference">...</div> </div>
             <div class="pattern-card"><h4>Custom Patterns</h4> <p>...</p> <div class="pattern-difference">...</div> </div>
        </div>

        <div class="back-to-top">
            <a href="#">Back to Top</a>
        </div>
    </div>
</body>
</html>